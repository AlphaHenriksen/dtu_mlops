name: "Run tests"

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: 3.10
    # Caching
    - name: Get data
      run: dvc pull
      env:
        GDRIVE_CREDENTIALS_DATA: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
    - name: Get pip cache dir
      id: pip-cache
      run: |
        echo "::set-output name=dir::$(pip cache dir)"

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ matrix.os }}-py${{ matrix.python-version }}-pt${{ matrix.pytorch-version }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ matrix.os }}-py${{ matrix.python-version }}-pt${{ matrix.pytorch-version }}-pip-

    - name: Install dependencies
      run: |
        pip install pip
        python -m pip install --upgrade pip
        pip install -r ././s2_organisation_and_version_control/exercise_files/corruptmnist/corruptmnist/requirements.txt
        pip install -r ././s2_organisation_and_version_control/exercise_files/corruptmnist/corruptmnist/requirements_tests.txt
    - name: Test with pytest
      run: |
        pip install pytest
        pytest -v
    
    # - name: Get pip cache dir
    #   id: pip-cache
    #   run: |
    #     echo "::set-output name=dir::$(pip cache dir)"

    # - name: Cache dependencies
    #   uses: actions/cache@v3
    #   with:
    #     path: ${{ steps.pip-cache.outputs.dir }}
    #     key: ${{ matrix.os }}-py${{ matrix.python-version }}-pt${{ matrix.pytorch-version }}-pip-${{ hashFiles('././s2_organisation_and_version_control/exercise_files/corruptmnist/corruptmnist/requirements.txt') }}
    #     restore-keys: |
    #       ${{ matrix.os }}-py${{ matrix.python-version }}-pt${{ matrix.pytorch-version }}-pip-
